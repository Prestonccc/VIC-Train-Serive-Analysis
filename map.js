// map json data
let lga_population=
[
    {
      "LGA": "Alpine",
      "Adult Population 2020": "10364"
    },
    {
      "LGA": "Ararat",
      "Adult Population 2020": "9777"
    },
    {
      "LGA": "Ballarat",
      "Adult Population 2020": "85891"
    },
    {
      "LGA": "Banyule",
      "Adult Population 2020": "103351"
    },
    {
      "LGA": "Bass Coast",
      "Adult Population 2020": "29699"
    },
    {
      "LGA": "Baw Baw",
      "Adult Population 2020": "41733"
    },
    {
      "LGA": "Bayside",
      "Adult Population 2020": "84052"
    },
    {
      "LGA": "Benalla",
      "Adult Population 2020": "11478"
    },
    {
      "LGA": "Boroondara",
      "Adult Population 2020": "146074"
    },
    {
      "LGA": "Brimbank",
      "Adult Population 2020": "165279"
    },
    {
      "LGA": "Buloke",
      "Adult Population 2020": "4901"
    },
    {
      "LGA": "Campaspe",
      "Adult Population 2020": "29724"
    },
    {
      "LGA": "Cardinia",
      "Adult Population 2020": "85551"
    },
    {
      "LGA": "Casey",
      "Adult Population 2020": "268065"
    },
    {
      "LGA": "Central Goldfields",
      "Adult Population 2020": "10853"
    },
    {
      "LGA": "Colac Otway",
      "Adult Population 2020": "17065"
    },
    {
      "LGA": "Corangamite",
      "Adult Population 2020": "12495"
    },
    {
      "LGA": "Darebin",
      "Adult Population 2020": "135619"
    },
    {
      "LGA": "East Gippsland",
      "Adult Population 2020": "38508"
    },
    {
      "LGA": "Frankston",
      "Adult Population 2020": "112322"
    },
    {
      "LGA": "Gannawarra",
      "Adult Population 2020": "8405"
    },
    {
      "LGA": "Glen Eira",
      "Adult Population 2020": "123025"
    },
    {
      "LGA": "Glenelg",
      "Adult Population 2020": "15812"
    },
    {
      "LGA": "Golden Plains",
      "Adult Population 2020": "17723"
    },
    {
      "LGA": "Greater Bendigo",
      "Adult Population 2020": "92151"
    },
    {
      "LGA": "Greater Dandenong",
      "Adult Population 2020": "134847"
    },
    {
      "LGA": "Greater Geelong",
      "Adult Population 2020": "207369"
    },
    {
      "LGA": "Greater Shepparton",
      "Adult Population 2020": "51213"
    },
    {
      "LGA": "Hepburn",
      "Adult Population 2020": "13093"
    },
    {
      "LGA": "Hindmarsh",
      "Adult Population 2020": "4500"
    },
    {
      "LGA": "Hobsons Bay",
      "Adult Population 2020": "76700"
    },
    {
      "LGA": "Horsham",
      "Adult Population 2020": "15403"
    },
    {
      "LGA": "Hume",
      "Adult Population 2020": "178459"
    },
    {
      "LGA": "Indigo",
      "Adult Population 2020": "13192"
    },
    {
      "LGA": "Kingston",
      "Adult Population 2020": "131857"
    },
    {
      "LGA": "Knox",
      "Adult Population 2020": "130097"
    },
    {
      "LGA": "Latrobe",
      "Adult Population 2020": "59674"
    },
    {
      "LGA": "Loddon",
      "Adult Population 2020": "6089"
    },
    {
      "LGA": "Macedon Ranges",
      "Adult Population 2020": "38666"
    },
    {
      "LGA": "Manningham",
      "Adult Population 2020": "103412"
    },
    {
      "LGA": "Mansfield",
      "Adult Population 2020": "7245"
    },
    {
      "LGA": "Maribyrnong",
      "Adult Population 2020": "78962"
    },
    {
      "LGA": "Maroondah",
      "Adult Population 2020": "93351"
    },
    {
      "LGA": "Melbourne",
      "Adult Population 2020": "176095"
    },
    {
      "LGA": "Melton",
      "Adult Population 2020": "123187"
    },
    {
      "LGA": "Mildura",
      "Adult Population 2020": "43495"
    },
    {
      "LGA": "Mitchell",
      "Adult Population 2020": "35880"
    },
    {
      "LGA": "Moira",
      "Adult Population 2020": "23832"
    },
    {
      "LGA": "Monash",
      "Adult Population 2020": "166561"
    },
    {
      "LGA": "Moonee Valley",
      "Adult Population 2020": "105764"
    },
    {
      "LGA": "Moorabool",
      "Adult Population 2020": "27324"
    },
    {
      "LGA": "Moreland",
      "Adult Population 2020": "154280"
    },
    {
      "LGA": "Mornington Peninsula",
      "Adult Population 2020": "134636"
    },
    {
      "LGA": "Mount Alexander",
      "Adult Population 2020": "16332"
    },
    {
      "LGA": "Moyne",
      "Adult Population 2020": "13031"
    },
    {
      "LGA": "Murrindindi",
      "Adult Population 2020": "12075"
    },
    {
      "LGA": "Nillumbik",
      "Adult Population 2020": "49897"
    },
    {
      "LGA": "Northern Grampians",
      "Adult Population 2020": "9199"
    },
    {
      "LGA": "Port Phillip",
      "Adult Population 2020": "102021"
    },
    {
      "LGA": "Pyrenees",
      "Adult Population 2020": "6033"
    },
    {
      "LGA": "Queenscliffe",
      "Adult Population 2020": "2563"
    },
    {
      "LGA": "South Gippsland",
      "Adult Population 2020": "23556"
    },
    {
      "LGA": "Southern Grampians",
      "Adult Population 2020": "12707"
    },
    {
      "LGA": "Stonnington",
      "Adult Population 2020": "102418"
    },
    {
      "LGA": "Strathbogie",
      "Adult Population 2020": "8891"
    },
    {
      "LGA": "Surf Coast",
      "Adult Population 2020": "26002"
    },
    {
      "LGA": "Swan Hill",
      "Adult Population 2020": "16042"
    },
    {
      "LGA": "Towong",
      "Adult Population 2020": "4945"
    },
    {
      "LGA": "Wangaratta",
      "Adult Population 2020": "23109"
    },
    {
      "LGA": "Warrnambool",
      "Adult Population 2020": "27563"
    },
    {
      "LGA": "Wellington",
      "Adult Population 2020": "35002"
    },
    {
      "LGA": "West Wimmera",
      "Adult Population 2020": "2987"
    },
    {
      "LGA": "Whitehorse",
      "Adult Population 2020": "144210"
    },
    {
      "LGA": "Whittlesea",
      "Adult Population 2020": "177660"
    },
    {
      "LGA": "Wodonga",
      "Adult Population 2020": "32702"
    },
    {
      "LGA": "Wyndham",
      "Adult Population 2020": "203152"
    },
    {
      "LGA": "Yarra",
      "Adult Population 2020": "89622"
    },
    {
      "LGA": "Yarra Ranges",
      "Adult Population 2020": "123642"
    },
    {
      "LGA": "Yarriambiack",
      "Adult Population 2020": "5258"
    }
  ];

// layer config
let layers = [{
  "name": "Host",
  "color": "#f10202"
  },
  {
      "name": "Unmanned",
      "color": "#0fe0cd"
  },
  {
      "name": "Premium",
      "color": "#ffcb01"
  },
  {
      "name": "Others",
      "color": "#0be802"
  }
];

var lgas=[]
var lga_pop={}

// station type full name
var stationType_dict={
  'Host':"Host Station",
  'Unmanned':"Unmanned Station",
  'Premium': "Premium Station",
  'Others':"Station"
};

// vLine detect
var vLineDetect={
  'V/Line Train':'Yes',
  'Train':'No'
}

// mapbox config
$(document).ready(function () {
  /*Map Part Start*/
  mapboxgl.accessToken = 'pk.eyJ1IjoieWxjYWkiLCJhIjoiY2t0b2t1OHB5MDdvOTJucXNuNWRidm1zdiJ9.ojpvy4Lr0zkkFJi7mc5BEQ';
  let map = new mapboxgl.Map({
  container: 'map',
      style: 'mapbox://styles/mapbox/dark-v10',
      center: [144.9, -37.75],
      zoom: 8
  });

  map.on('load', e => {
      map.addSource('ABB_NAME', {
          type: 'vector',
          url: 'mapbox://ylcai.bcwl9mvy'
      });

      // add a new layer of lga population
      for (let lga of lga_population) {
          lgas.push(lga["LGA"])
          lga_pop[lga["LGA"]]=lga["Adult Population 2020"]
          map.addLayer({
              'id': lga["LGA"],
              'type': 'fill',
              'source': 'ABB_NAME',
              'source-layer': 'vic_lga_polygon_shp-7z25du',
              'paint': {
                  'fill-color': [
                      'interpolate',
                      ['linear'],
                      parseInt(lga["Adult Population 2020"]),
                      0,
                      '#F2F12D',
                      10000,
                      '#EED322',
                      20000,
                      '#E6B71E',
                      30000,
                      '#DA9C20',
                      50000,
                      '#CA8323',
                      100000,
                      '#B86B25',
                      150000,
                      '#A25626',
                      200000,
                      '#8B4225',
                      250000,
                      '#723122'
                  ],
                  'fill-outline-color': 'rgb(255,255,255)',
                  'fill-opacity': 0.75
              },
              "filter": ["==", "ABB_NAME", lga["LGA"]]
          });

          
      };

      map.addSource('STATIONTYP', {
          type: 'vector',
          url: 'mapbox://ylcai.a4l0p1bi'
      });

      let legend = document.querySelector('#legend');

      // add a new layer of station
      for (let layer of layers) {

          map.addLayer({
              'id': layer.name,
              'type': 'circle',
              'source': 'STATIONTYP',
              'source-layer': 'trainStations_19_edit-7oh0qh',
              "minzoom": 8,
              'paint': {
                  // Make circles larger as the user zooms from z12 to z22.
                  'circle-radius': {
                      'base': 1.75,
                      'stops': [
                          [3, 3],
                          [15, 50]
                      ]
                  },
                  // Color circles by ethnicity, using a `match` expression.
                  'circle-color': layer.color,
              },
              "filter": ["==", "STATIONTYP", layer.name]
          });

          //start show points on the map from zoom level 5 with 0.3 opacity, get 1 opacity at level 7
          map.setPaintProperty(layer.name, 'circle-opacity', [
          'interpolate',
          ['exponential', 0.7],
          ['zoom'],
          8,
          0.5,
          10,
          1
          ]);

          //Legend
          let item = document.createElement('div');

          let key = document.createElement('span');
          key.classList.add('legend-key');
          key.style.backgroundColor = layer.color;

          let value = document.createElement('span');
          value.innerHTML=stationType_dict[layer.name];

          item.appendChild(key);
          item.appendChild(value);
          legend.appendChild(item);
      }

      // mouse hover effect setting
      map.on('mousemove', e => {
          let stationInfo = map.queryRenderedFeatures(e.point, {
              layers: lgas
          });

          if (stationInfo.length > 0) {
              var lgaName=stationInfo[0].properties.LGA_NAME
              var lgaShort=stationInfo[0].properties.ABB_NAME
              var lgaPopulcation=lga_pop[lgaShort]

              document.querySelector('#info').innerHTML = '<p>The <span style="font-weight: bold">'+ lgaName +'</span>  has <span style="font-weight: bold">'+ lgaPopulcation +'</span> adult residents. <br/><br>It is also known as <span style="font-weight: bold">' + lgaShort +'</span> in short.</p>';
          } else {
              document.querySelector('#info').innerHTML = '<p>Move your mouse over a location to view details.</p>';
          }
      });

      //Pop_up function
      function pop_up(map, layer) {
          map.on('mouseenter', layer, e => {
              map.getCanvas().style.cursor = 'pointer';
          });

          map.on('mouseleave', layer, e => {
              map.getCanvas().style.cursor = '';
          });

          map.on('click', layer, e => {
              console.log(e.features[0].properties);
              new mapboxgl.Popup()
                  .setLngLat(e.lngLat)
                  .setHTML('Station Name: ' + e.features[0].properties.STATIONNAM + '<br/> Type: ' + stationType_dict[e.features[0].properties.STATIONTYP] + '<br/> V/Line Train: ' + vLineDetect[e.features[0].properties.STOPMODENA] + '<br/> Service Zone: ' + e.features[0].properties.ZONES
                  )
                  .addTo(map);
          });
      }

      for (let layer of layers) {
          pop_up(map, layer["name"]);
      }

  });

  //add Geological Searcher
  // Add the control to the map.
  map.addControl(
      new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl: mapboxgl
      })
  );

  //add Navigation Controller
  map.addControl(new mapboxgl.NavigationControl());
  //add Scale Meter
  map.addControl(new mapboxgl.ScaleControl());

  //function to zoom out to fly back to the initial position
  document.getElementById('backButton').addEventListener('click', () => {
      map.flyTo({
          center: [144.9, -37.75],
          zoom: 8
      });
  });
});